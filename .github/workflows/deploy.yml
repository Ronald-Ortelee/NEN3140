name: Deploy Laravel Application to Production Servert
# on:
#   push:
#     branches:
#       - main

on: workflow_dispatch

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      # Map GitHub Secrets to environment variables
      APP_ENV: production
      APP_DEBUG: false
      APP_URL: ${{ secrets.APP_URL }}
      APP_NAME: ${{ secrets.APP_NAME }}
      LOG_CHANNEL: stack
      LOG_LEVEL: info

      DB_CONNECTION: mysql
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_DATABASE: ${{ secrets.DB_NAME }}
      DB_USERNAME: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PWD }}

      # Cache/Queue/Session (adjust as needed)
      CACHE_DRIVER: redis
      QUEUE_CONNECTION: redis
      SESSION_DRIVER: redis
      REDIS_HOST: ${{ secrets.REDIS_HOST }}
      REDIS_PORT: ${{ secrets.REDIS_PORT }}
      REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}

      # Mail (adjust if using different provider)
    #   MAIL_MAILER: smtp
    #   MAIL_HOST: ${{ secrets.MAIL_HOST }}
    #   MAIL_PORT: ${{ secrets.MAIL_PORT }}
    #   MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
    #   MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
    #   MAIL_ENCRYPTION: ${{ secrets.MAIL_ENCRYPTION }}
    #   MAIL_FROM_ADDRESS: ${{ secrets.MAIL_FROM_ADDRESS }}
    #   MAIL_FROM_NAME: ${{ secrets.MAIL_FROM_NAME }}

      # Any other service keys
      # STRIPE_KEY: ${{ secrets.STRIPE_KEY }}
      # STRIPE_SECRET: ${{ secrets.STRIPE_SECRET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, pdo, mysql, redis
          tools: composer
          coverage: none

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      - name: Install dependencies
        run: composer install --no-dev --prefer-dist --no-interaction --no-progress --optimize-autoloader

      - name: Copy .env.example to .env
        run: cp .env.example .env

      - name: Write GitHub Secrets to .env
        shell: bash
        run: |
          # Helper to set or replace a key in .env
          set_env() {
            KEY="$1"
            VALUE="$2"
            # Escape slashes and ampersands for sed
            ESCAPED=$(printf '%s\n' "$VALUE" | sed -e 's/[\/&]/\\&/g')
            if grep -q "^${KEY}=" .env; then
              sed -i "s/^${KEY}=.*/${KEY}=${ESCAPED}/" .env
            else
              echo "${KEY}=${VALUE}" >> .env
            fi
          }

          set_env APP_NAME        "${APP_NAME}"
          set_env APP_ENV         "${APP_ENV}"
          set_env APP_DEBUG       "${APP_DEBUG}"
          set_env APP_URL         "${APP_URL}"
          set_env LOG_CHANNEL     "${LOG_CHANNEL}"
          set_env LOG_LEVEL       "${LOG_LEVEL}"

          set_env DB_CONNECTION   "${DB_CONNECTION}"
          set_env DB_HOST         "${DB_HOST}"
          set_env DB_PORT         "${DB_PORT}"
          set_env DB_DATABASE     "${DB_DATABASE}"
          set_env DB_USERNAME     "${DB_USERNAME}"
          set_env DB_PASSWORD     "${DB_PASSWORD}"

          set_env CACHE_DRIVER    "${CACHE_DRIVER}"
          set_env QUEUE_CONNECTION "${QUEUE_CONNECTION}"
          set_env SESSION_DRIVER  "${SESSION_DRIVER}"
          set_env REDIS_HOST      "${REDIS_HOST}"
          set_env REDIS_PORT      "${REDIS_PORT}"
          set_env REDIS_PASSWORD  "${REDIS_PASSWORD}"

          set_env MAIL_MAILER     "${MAIL_MAILER}"
          set_env MAIL_HOST       "${MAIL_HOST}"
          set_env MAIL_PORT       "${MAIL_PORT}"
          set_env MAIL_USERNAME   "${MAIL_USERNAME}"
          set_env MAIL_PASSWORD   "${MAIL_PASSWORD}"
          set_env MAIL_ENCRYPTION "${MAIL_ENCRYPTION}"
          set_env MAIL_FROM_ADDRESS "${MAIL_FROM_ADDRESS}"
          set_env MAIL_FROM_NAME  "${MAIL_FROM_NAME}"

          # Uncomment if you have additional keys
          # set_env STRIPE_KEY       "${STRIPE_KEY}"
          # set_env STRIPE_SECRET    "${STRIPE_SECRET}"

      - name: Generate APP_KEY
        run: php artisan key:generate --force

      - name: Optimize framework
        run: |
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache

      # Optional: build front-end assets if using Vite
      - name: Node setup and build (optional)
        if: ${{ false }} # set to true if you need assets build
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install and build front-end (optional)
        if: ${{ false }} # set to true if you need assets build
        run: |
          npm ci
          npm run build

      # Example deployment via SSH and rsync (adjust to your stack)
      - name: Deploy to server (example)
        if: ${{ secrets.REMOTE_HOST && secrets.REMOTE_USER && secrets.SSH_PRIVATE_KEY }}
        uses: burnett01/rsync-deployments@7.1.0
        with:
          switches: -avzr --delete --exclude='.git' --exclude='node_modules' --exclude='tests'
          path: .
          remote_path: ${{ secrets.TARGET }}
          remote_host: ${{ secrets.REMOTE_HOST }}
          remote_user: ${{ secrets.REMOTE_USER }}
          remote_key: ${{ secrets.SSH_PRIVATE_KEY }}

      # Optional: run migrations on remote (example using SSH)
      - name: Run migrations on remote (optional)
        if: ${{ secrets.REMOTE_HOST && secrets.REMOTE_USER && secrets.SSH_PRIVATE_KEY }}
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd ${{ secrets.TARGET }}
            php artisan migrate --force
